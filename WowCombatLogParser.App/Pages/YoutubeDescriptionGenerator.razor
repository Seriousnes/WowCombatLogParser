@inherits AppComponentBase
@page "/youtube"
@using WoWCombatLogParser

<MudGrid>
	<MudItem xs="4">
		@if (loading || encounterList is null)
		{
			<MudList>
				<MudSkeleton SkeletonType="SkeletonType.Rectangle" Animation="Animation.Wave"></MudSkeleton>
			</MudList>
		}
		else
		{
			<MudList Clickable="true" Dense="true">
				@foreach (var encounters in encounterList)
				{
					<MudListItem Text="@encounters.Key">
						<NestedList>
							@{
								@foreach (var (encounter, i) in encounters.Value.Select((x, i) => (x, i + 1)))
								{
									var fightDetails = encounter.GetDetails();
									<MudListItem>
										<MudText Color="@(fightDetails.Result == "Kill" ? Color.Surface : Color.Error)">
											@if (fightDetails.Result == "Kill")
											{
												@:Kill
											}
											else
											{
												@: Wipe @(i) - @fightDetails.Duration
											}
										</MudText>
									</MudListItem>
								}
							}
						</NestedList>
					</MudListItem>
				}
			</MudList>
		}
	</MudItem>
	<MudItem xs="8">

	</MudItem>
</MudGrid>

	@code {
	string baseDirectory = @"E:\Games\World of Warcraft\_retail_\Logs";

	Dictionary<string, List<IFight>> encounterList;
	bool loading = true;

	protected override async Task OnParametersSetAsync()
	{
		var log = Directory.GetFiles(baseDirectory, "WowCombatLog*.txt")
				.Select(x => new FileInfo(x))
				.OrderByDescending(x => x.LastAccessTime)
				.Select(x => x.FullName)
				.FirstOrDefault();

		if (!File.Exists(log))
		{
			return;
		}

		CombatLogParser.SetFilePath(log);
		var segments = await CombatLogParser.GetSegmentsAsync();

		encounterList = segments
			.Select(x =>
			{
				IFight encounter = x.Start switch
				{
					EncounterStart start => new BossEncounter(start),
					ChallengeModeStart start => new ChallengeModeEncounter(start),
					ArenaMatchStart start => new ArenaMatch(start),
					_ => null
				};

				if (encounter is not null)
				{
					encounter.AddEvent(x.End as CombatLogEvent);
				}
				return encounter;
			})
			.Where(x => x is not null)
			.GroupBy(x => x.Name)
			.ToDictionary(x => x.Key, x => x.ToList());

		loading = false;
	}
}
